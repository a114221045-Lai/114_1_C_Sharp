using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;

namespace Q1
{
    public partial class Form1 : Form
    {
        private enum Choice { Rock = 0, Paper = 1, Scissor = 2 }

        private readonly Random _rng = new Random();
        private Choice _playerChoice;
        private Choice _computerChoice;
        private int _playerWins = 0;
        private int _computerWins = 0;

        // 快取產生好的圖片 (用 Emoji 畫在棕色底上)
        private readonly Dictionary<string, Image> _imageCache = new Dictionary<string, Image>();

        public Form1()
        {
            InitializeComponent();
            // 初始化 UI 狀態
            this.resultLabel.ReadOnly = true;
            this.resultLabel.TextAlign = HorizontalAlignment.Center;
            this.computerPictureBox.SizeMode = PictureBoxSizeMode.Zoom;
            this.playerPictureBox.SizeMode = PictureBoxSizeMode.Zoom;
            this.exitButton.Click += exitButton_Click;

            // 預設清空圖片
            this.computerPictureBox.Image = CreateEmojiBitmap("", new Size(this.computerPictureBox.Width, this.computerPictureBox.Height));
            this.playerPictureBox.Image = CreateEmojiBitmap("", new Size(this.playerPictureBox.Width, this.playerPictureBox.Height));
        }

        private void stoneButton_Click(object sender, EventArgs e)
        {
            _playerChoice = Choice.Rock;
            getCompChoice();
            showPlayerImage();
            showComputerImage();
            showWinner();
        }

        private void paperButton_Click(object sender, EventArgs e)
        {
            _playerChoice = Choice.Paper;
            getCompChoice();
            showPlayerImage();
            showComputerImage();
            showWinner();
        }

        private void scissorButton_Click(object sender, EventArgs e)
        {
            _playerChoice = Choice.Scissor;
            getCompChoice();
            showPlayerImage();
            showComputerImage();
            showWinner();
        }

        private void exitButton_Click(object sender, EventArgs e)
        {
            MessageBox.Show("遊戲結果！\r\n\r\n玩家贏了" + _playerWins + "次\r\n電腦贏了" + _computerWins + "次", "遊戲統計", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // 產生電腦隨機選擇
        private void getCompChoice()
        {
            _computerChoice = (Choice)_rng.Next(0, 3);
        }

        // 顯示電腦圖片
        private void showComputerImage()
        {
            this.computerPictureBox.Image = GetImageForChoice(true, _computerChoice);
        }

        // 顯示玩家圖片
        private void showPlayerImage()
        {
            this.playerPictureBox.Image = GetImageForChoice(false, _playerChoice);
        }

        // 判斷勝負與結果
        private void showWinner()
        {
            int result = Judge(_playerChoice, _computerChoice);
            if (result == 1)
            {
                _playerWins++;
                resultLabel.Text = "玩家贏";
            }
            else if (result == -1)
            {
                _computerWins++;
                resultLabel.Text = "電腦贏";
            }
            else
            {
                resultLabel.Text = "平手";
            }
        }

        private int Judge(Choice player, Choice cpu)
        {
            if (player == cpu) return 0;
            if ((player == Choice.Rock && cpu == Choice.Scissor) ||
                (player == Choice.Paper && cpu == Choice.Rock) ||
                (player == Choice.Scissor && cpu == Choice.Paper))
            {
                return 1;
            }
            return -1;
        }

        private Image GetImageForChoice(bool isComputer, Choice choice)
        {
            string key = (isComputer ? "C_" : "P_") + ((int)choice).ToString();
            Image img;
            if (_imageCache.TryGetValue(key, out img)) return img;

            // 指定各選擇對應的 emoji
            string emoji = "";
            if (choice == Choice.Rock) emoji = "✊";
            else if (choice == Choice.Paper) emoji = "✋";
            else emoji = "✌";

            img = CreateEmojiBitmap(emoji, new Size(240, 120));
            _imageCache[key] = img;
            return img;
        }

        // 以指定 emoji 繪製一張棕色底圖，避免必須外部圖片資源
        private static Bitmap CreateEmojiBitmap(string emoji, Size size)
        {
            var bmp = new Bitmap(Math.Max(1, size.Width), Math.Max(1, size.Height));
            using (var g = Graphics.FromImage(bmp))
            using (var bg = new SolidBrush(Color.Peru))
            using (var txt = new SolidBrush(Color.Black))
            {
                g.FillRectangle(bg, 0, 0, bmp.Width, bmp.Height);

                if (!string.IsNullOrEmpty(emoji))
                {
                    // 嘗試用支援 emoji 的字型
                    using (var font = new Font("Segoe UI Emoji", 72, FontStyle.Regular, GraphicsUnit.Point))
                    {
                        var sz = g.MeasureString(emoji, font);
                        float x = (bmp.Width - sz.Width) / 2f;
                        float y = (bmp.Height - sz.Height) / 2f;
                        g.DrawString(emoji, font, txt, x, y);
                    }
                }
            }
            return bmp;
        }
    }
}
